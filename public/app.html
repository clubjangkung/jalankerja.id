<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - jalankerja.id</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-functions.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .screen { display: none; }
        .screen.active { display: block; }
        .input-field {
            background-color: #f8f9fa;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            width: 100%;
        }
        .input-field:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }
        .cta-button { transition: all 0.3s ease; }
        .cta-button:hover { transform: translateY(-2px); }
    </style>
</head>
<body class="text-gray-800">

    <div id="app-container" class="w-full min-h-screen flex items-center justify-center p-4">
        <!-- Loading Screen -->
        <div id="loading-screen" class="screen active text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-600"></div>
            <p class="mt-4 font-semibold text-gray-600">Memuat...</p>
        </div>

        <!-- Login / Register Screen -->
        <div id="auth-screen-container" class="screen w-full max-w-md">
            <!-- Login/Register content will be rendered here -->
        </div>

        <!-- Main Dashboard Layout -->
        <div id="dashboard-layout" class="screen w-full max-w-6xl">
             <!-- Dashboard content will be rendered here -->
        </div>
    </div>

<script type="module">
    // --- FIREBASE SETUP ---
    // PENTING: Ganti dengan konfigurasi Firebase Anda
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_AUTH_DOMAIN",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_STORAGE_BUCKET",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID"
    };
    
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const functions = firebase.functions();

    // --- STATE MANAGEMENT ---
    let state = {
        currentPage: 'loading', // loading, login, register, test, result, admin_dashboard
        user: null,
        userData: null,
    };

    // --- RENDER FUNCTIONS ---
    const renderApp = () => {
        const loadingScreen = document.getElementById('loading-screen');
        const authContainer = document.getElementById('auth-screen-container');
        const dashboardLayout = document.getElementById('dashboard-layout');

        loadingScreen.classList.add('hidden');

        if (!state.user) {
            authContainer.classList.remove('hidden');
            dashboardLayout.classList.add('hidden');
            authContainer.innerHTML = state.currentPage === 'register' ? renderRegister() : renderLogin();
        } else {
            authContainer.classList.add('hidden');
            dashboardLayout.classList.remove('hidden');
            // Render dashboard content based on user role and test status
            // ...
        }
        attachEventListeners();
    };

    const renderLogin = () => `
        <div class="bg-white p-8 rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Masuk</h2>
            <form id="login-form" class="space-y-6">
                <input type="email" id="login-email" placeholder="Email" class="input-field" required>
                <input type="password" id="login-password" placeholder="Password" class="input-field" required>
                <button type="submit" class="w-full bg-indigo-600 text-white p-3 font-bold rounded-lg cta-button">Masuk</button>
            </form>
            <p class="text-center mt-4">Belum punya akun? <a href="#" id="show-register" class="text-indigo-600 font-semibold">Daftar di sini</a></p>
            <p id="auth-error" class="text-red-500 text-center mt-4 h-5"></p>
        </div>
    `;

    const renderRegister = () => `
         <div class="bg-white p-8 rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Pendaftaran Siswa</h2>
            <form id="register-form" class="space-y-4">
                <input type="text" id="register-name" placeholder="Nama Lengkap" class="input-field" required>
                <input type="email" id="register-email" placeholder="Email" class="input-field" required>
                <input type="password" id="register-password" placeholder="Buat Password (min. 6 karakter)" class="input-field" required>
                <input type="text" id="school-access-code" placeholder="Masukkan Kode Akses dari Sekolah" class="input-field uppercase" required>
                <button type="submit" class="w-full bg-indigo-600 text-white p-3 font-bold rounded-lg cta-button">Daftar & Mulai Tes</button>
            </form>
            <p class="text-center mt-4">Sudah punya akun? <a href="#" id="show-login" class="text-indigo-600 font-semibold">Masuk di sini</a></p>
        </div>
    `;
    
    // ... (Fungsi render lainnya: dashboard, test, result, admin)

    // --- LOGIC FUNCTIONS ---
    const handleRegister = async (name, email, password, schoolCode) => {
        const registerButton = document.querySelector('#register-form button');
        registerButton.disabled = true;
        registerButton.textContent = 'Memproses...';

        try {
            const validateAndRegister = functions.httpsCallable('validateAndRegisterUser');
            const result = await validateAndRegister({ name, email, password, schoolCode: schoolCode.toUpperCase() });

            if (result.data.success) {
                // Login otomatis setelah pendaftaran berhasil
                await auth.signInWithEmailAndPassword(email, password);
                // onAuthStateChanged akan menangani sisanya
            } else {
                throw new Error(result.data.error || 'Kode akses tidak valid atau kuota sudah habis.');
            }
        } catch (error) {
            alert(`Pendaftaran Gagal: ${error.message}`);
            registerButton.disabled = false;
            registerButton.textContent = 'Daftar & Mulai Tes';
        }
    };
    
    const handleLogin = async (email, password) => {
        const loginButton = document.querySelector('#login-form button');
        loginButton.disabled = true;
        loginButton.textContent = 'Memproses...';
        document.getElementById('auth-error').textContent = '';
        try {
            await auth.signInWithEmailAndPassword(email, password);
        } catch (error) {
            document.getElementById('auth-error').textContent = 'Email atau password salah.';
            loginButton.disabled = false;
            loginButton.textContent = 'Masuk';
        }
    };

    // --- EVENT LISTENERS & INITIALIZATION ---
    const attachEventListeners = () => {
        // ... (Event listener untuk logout, start test, dll.)

        const showRegisterLink = document.getElementById('show-register');
        if (showRegisterLink) {
            showRegisterLink.addEventListener('click', e => {
                e.preventDefault();
                state.currentPage = 'register';
                renderApp();
            });
        }

        const showLoginLink = document.getElementById('show-login');
        if (showLoginLink) {
            showLoginLink.addEventListener('click', e => {
                e.preventDefault();
                state.currentPage = 'login';
                renderApp();
            });
        }

        const loginForm = document.getElementById('login-form');
        if (loginForm) {
            loginForm.addEventListener('submit', e => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                handleLogin(email, password);
            });
        }
        
        const registerForm = document.getElementById('register-form');
        if (registerForm) {
            registerForm.addEventListener('submit', e => {
                e.preventDefault();
                const name = document.getElementById('register-name').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const schoolCode = document.getElementById('school-access-code').value;
                handleRegister(name, email, password, schoolCode);
            });
        }
    };
    
    // Fungsi untuk membaca "Link Ajaib"
    const checkUrlForCode = () => {
        const urlParams = new URLSearchParams(window.location.search);
        const schoolCode = urlParams.get('kode');
        if (schoolCode) {
            state.currentPage = 'register'; // Langsung arahkan ke halaman daftar
            // Tunggu DOM siap, lalu isi field
            setTimeout(() => {
                const codeInput = document.getElementById('school-access-code');
                if (codeInput) {
                    codeInput.value = schoolCode.toUpperCase();
                }
            }, 100);
        }
    };

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            state.user = user;
            const userDoc = await db.collection('users').doc(user.uid).get();
            if (userDoc.exists) {
                state.userData = userDoc.data();
                if (state.userData.role === 'admin') {
                    state.currentPage = 'admin_dashboard';
                } else if (state.userData.testAttemptsRemaining > 0) {
                    state.currentPage = 'test';
                } else {
                    state.currentPage = 'result';
                }
            }
        } else {
            state.user = null;
            state.userData = null;
            state.currentPage = 'login';
            checkUrlForCode(); // Cek kode hanya jika user belum login
        }
        renderApp();
    });

    renderApp();
</script>
</body>
</html>
