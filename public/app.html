<!DOCTYPE html>
<!-- INI ADALAH TES PERUBAHAN FINAL -->
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>Dashboard - jalankerja</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-functions.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <!-- PDF Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .screen { display: none; }
        .screen.active { display: block; }
        .sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar-link { transition: all 0.2s ease; }
        .sidebar-link:hover, .sidebar-link.active { background-color: #eef2ff; color: #4f46e5; border-radius: 8px; font-weight: 600; }
        .kpi-card { background: white; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .cta-button { transition: all 0.3s ease; }
        .cta-button:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(79, 70, 229, 0.2); }
        .input-field {
            background-color: #f8f9fa;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            width: 100%;
        }
        .input-field:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="app-container" class="w-full">
        <!-- Loading Screen -->
        <div id="loading-screen" class="screen active min-h-screen flex items-center justify-center">
             <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-600 mx-auto"></div>
                <p class="mt-4 font-semibold text-gray-600">Memuat...</p>
            </div>
        </div>

        <!-- Main Dashboard Layout (HANYA UNTUK PENGGUNA YANG SUDAH LOGIN) -->
        <div id="dashboard-layout" class="screen">
            <div class="flex h-screen bg-gray-100">
                <!-- Sidebar -->
                <aside id="sidebar-container" class="w-64 bg-white shadow-lg flex-shrink-0 hidden lg:flex flex-col">
                    <!-- Sidebar content will be rendered here -->
                </aside>
                
                <!-- Main Content -->
                <main class="flex-1 flex flex-col overflow-hidden">
                    <header class="flex justify-between items-center p-4 bg-white border-b">
                        <div class="flex items-center">
                            <button id="menu-toggle-btn" class="text-gray-500 focus:outline-none lg:hidden">
                                <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 6H20M4 12H20M4 18H11" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            </button>
                            <h1 id="dashboard-title" class="text-xl font-semibold ml-4">Dashboard</h1>
                        </div>
                        <div class="flex items-center space-x-4">
                            <div class="text-right">
                                <p id="user-profile-name" class="font-semibold text-sm">Nama Pengguna</p>
                                <p id="user-profile-role" class="text-xs text-gray-500">Peran</p>
                            </div>
                            <button id="logout-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-red-600">Keluar</button>
                        </div>
                    </header>
                    <div id="main-content-container" class="flex-1 p-6 overflow-y-auto">
                        <!-- Dashboard content will be rendered here -->
                    </div>
                </main>
            </div>
        </div>
    </div>

<script type="module">
    // --- FIREBASE SETUP ---
    // PENTING: Ganti dengan konfigurasi Firebase Anda
    const firebaseConfig = {
  apiKey: "AIzaSyA5KSxBE05HqdDM9rvu_ZAJHhxhtZQAWjY",
  authDomain: "jalankerja-id.firebaseapp.com",
  projectId: "jalankerja-id",
  storageBucket: "jalankerja-id.firebasestorage.app",
  messagingSenderId: "618843238157",
  appId: "1:618843238157:web:356b3f4eb985f259668a44",
  measurementId: "G-120E5TY2YZ"
    };
    
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const functions = firebase.functions();
    const storage = firebase.storage();

    // --- STATE MANAGEMENT ---
    let state = {
        currentPage: 'loading',
        user: null,
        userData: null,
    };

    // --- RENDER FUNCTIONS ---
    const renderApp = () => {
        const loadingScreen = document.getElementById('loading-screen');
        const dashboardLayout = document.getElementById('dashboard-layout');

        if (state.currentPage === 'loading') {
            loadingScreen.classList.remove('hidden');
            dashboardLayout.classList.add('hidden');
            return;
        }

        loadingScreen.classList.add('hidden');
        dashboardLayout.classList.remove('hidden');
        
        document.getElementById('sidebar-container').innerHTML = renderSidebar();
        document.getElementById('user-profile-name').textContent = state.userData?.displayName || state.user.email;
        document.getElementById('user-profile-role').textContent = state.userData?.role === 'admin' ? 'Admin' : 'Siswa';

        const mainContent = document.getElementById('main-content-container');
        if (state.userData?.role === 'admin') {
            mainContent.innerHTML = renderAdminDashboardContent();
            // initAdminCharts(); // Panggil fungsi chart di sini jika perlu
        } else {
            mainContent.innerHTML = renderUserDashboardContent();
        }
        attachEventListeners();
    };
    
    const renderSidebar = () => {
        const isAdmin = state.userData?.role === 'admin';
        let links = '';
        if (isAdmin) {
            links = `<a href="#" class="sidebar-link active p-3">Dashboard Admin</a>`;
        } else {
            links = `<a href="#" class="sidebar-link active p-3">Dashboard Siswa</a>`;
        }
        return `
            <div class="p-4">
                <a href="index.html" class="text-2xl font-extrabold">jalan<span class="text-indigo-600">kerja</span></a>
            </div>
            <nav class="mt-6 px-4 space-y-2">${links}</nav>
        `;
    };

    const renderAdminDashboardContent = () => `
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold">Selamat Datang, Admin!</h2>
            <p class="mt-2 text-gray-600">Ini adalah panel kontrol Anda.</p>
            <!-- Tambahkan semua fitur admin di sini -->
        </div>
    `;

    const renderUserDashboardContent = () => `
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold">Selamat Datang, ${state.userData?.displayName}!</h2>
            <p class="mt-2 text-gray-600">Ini adalah dashboard siswa Anda.</p>
            <!-- Tambahkan semua fitur siswa di sini -->
        </div>
    `;

    // --- EVENT LISTENERS ---
    const attachEventListeners = () => {
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                await auth.signOut();
                window.location.href = 'login.html';
            });
        }
    };

    // --- INISIALISASI ---
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            console.log("User terdeteksi:", user.uid);
            state.user = user;
            try {
                const userDocRef = db.collection('users').doc(user.uid);
                const userDoc = await userDocRef.get();

                if (userDoc.exists) {
                    console.log("Data user ditemukan di Firestore.");
                    state.userData = userDoc.data();
                    // Langsung render, jangan set currentPage di sini
                    renderApp();
                } else {
                    console.error("User terotentikasi, tapi data tidak ditemukan di Firestore!");
                    // Paksa logout jika data tidak konsisten
                    await auth.signOut();
                }
            } catch (error) {
                console.error("Error saat mengambil data user:", error);
                await auth.signOut();
            }
        } else {
            console.log("Tidak ada user, mengarahkan ke halaman login.");
            window.location.href = 'login.html';
        }
    });
</script>
</body>
</html>
